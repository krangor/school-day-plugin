# .github/workflows/update-school-day.yml
name: Update School Day

on:
  schedule:
    # Run every day at 6 AM UTC (adjust timezone as needed)
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-school-day:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Create Python script
      run: |
        cat > update_school_day.py << 'EOF'
        import json
        from datetime import datetime
        
        # Read the calendar data
        with open('calendar.json', 'r') as f:
            calendar_data = json.load(f)
        
        # Get today's date
        today = datetime.now().strftime('%Y-%m-%d')
        school_day = calendar_data.get(today, 'Unknown')
        
        # Format the data for TRMNL
        if school_day == 'X':
            status = "No School"
            emoji = "🏠"
            is_school_day = False
        elif school_day == 'Unknown':
            status = "Day Not Found"
            emoji = "❓"
            is_school_day = False
        else:
            status = f"Day {school_day}"
            emoji = "🏫"
            is_school_day = True
        
        # Create the output data - try different formats for TRMNL
        output_data = {
            'school_day': school_day,
            'status': status,
            'emoji': emoji,
            'is_school_day': is_school_day,
            'date': today,
            'formatted_date': datetime.now().strftime('%B %d, %Y'),
            'day_name': datetime.now().strftime('%A'),
            'last_updated': datetime.now().isoformat(),
            # Also try flat structure
            'day': school_day,
            'message': status,
            'icon': emoji
        }
        
        # Write to today.json - try TRMNL-friendly format
        with open('today.json', 'w') as f:
            json.dump(output_data, f, indent=2)
        
        # Also create a simple text version for testing
        with open('today.txt', 'w') as f:
            f.write(f"{emoji} {status}\n{datetime.now().strftime('%B %d, %Y')}")
        
        print(f"Updated school day data: {status}")
        EOF
    
    - name: Run Python script
      run: python update_school_day.py
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add today.json today.txt
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update school day for $(date +%Y-%m-%d)"
          git pull --rebase
          git push
        fi
